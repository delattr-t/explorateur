<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Cartographe Explorateur</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IM+Fell+DW+Pica:ital@0;1&family=Cinzel+Decorative:wght@700&family=UnifrakturMaguntia&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'IM Fell DW Pica', serif;
            background: linear-gradient(135deg, #e8dcc4 0%, #d4c5a9 50%, #c9b896 100%);
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        /* Texture parchemin */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(139, 117, 87, 0.03) 2px, rgba(139, 117, 87, 0.03) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(139, 117, 87, 0.03) 2px, rgba(139, 117, 87, 0.03) 4px);
            pointer-events: none;
            z-index: 1;
        }
        
        /* Grain texture */
        body::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='3.5' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.08'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 2;
        }
        
        .container {
            position: relative;
            z-index: 3;
            height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        header {
            text-align: center;
            margin-bottom: 15px;
            position: relative;
        }
        
        h1 {
            font-family: 'Cinzel Decorative', cursive;
            font-size: 2.8em;
            color: #3a2817;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            letter-spacing: 3px;
            margin-bottom: 5px;
            animation: fadeInTitle 2s ease-out;
        }
        
        .subtitle {
            font-family: 'IM Fell DW Pica', serif;
            font-style: italic;
            font-size: 1.1em;
            color: #5a4a3a;
            letter-spacing: 2px;
        }
        
        @keyframes fadeInTitle {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .map-frame {
            flex: 1;
            position: relative;
            background: #f5ead8;
            border: 8px solid #3a2817;
            border-radius: 4px;
            box-shadow: 
                inset 0 0 30px rgba(90, 70, 50, 0.3),
                0 10px 30px rgba(0, 0, 0, 0.4),
                0 0 0 2px #6b5943,
                0 0 0 4px #3a2817;
            overflow: hidden;
        }
        
        /* Bordure d√©corative interne */
        .map-frame::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 2px solid rgba(58, 40, 23, 0.3);
            border-style: double;
            pointer-events: none;
            z-index: 10;
        }
        
        #mapCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            image-rendering: crisp-edges;
        }
        
        .compass {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 120px;
            height: 120px;
            z-index: 20;
            animation: floatCompass 6s ease-in-out infinite;
        }
        
        @keyframes floatCompass {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }
        
        .info-panel {
            position: absolute;
            bottom: 30px;
            left: 30px;
            background: rgba(245, 234, 216, 0.95);
            border: 3px double #3a2817;
            padding: 15px 20px;
            border-radius: 3px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            max-width: 350px;
            z-index: 20;
            animation: slideInInfo 1s ease-out 0.5s both;
        }
        
        @keyframes slideInInfo {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .info-panel h3 {
            font-family: 'Cinzel Decorative', cursive;
            font-size: 1.2em;
            color: #3a2817;
            margin-bottom: 10px;
            border-bottom: 1px solid #8b7557;
            padding-bottom: 5px;
        }
        
        .info-item {
            margin: 8px 0;
            font-size: 0.95em;
            color: #4a3a2a;
            line-height: 1.5;
        }
        
        .info-label {
            font-weight: bold;
            color: #3a2817;
            font-variant: small-caps;
        }
        
        .controls {
            position: absolute;
            top: 30px;
            left: 30px;
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        button {
            font-family: 'IM Fell DW Pica', serif;
            background: #5a4530;
            color: #f5ead8;
            border: 2px solid #3a2817;
            padding: 10px 20px;
            font-size: 0.95em;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
        }
        
        button:hover {
            background: #6b5540;
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .legend {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(245, 234, 216, 0.95);
            border: 3px double #3a2817;
            padding: 15px;
            border-radius: 3px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 20;
            min-width: 200px;
        }
        
        .legend h4 {
            font-family: 'Cinzel Decorative', cursive;
            font-size: 1em;
            color: #3a2817;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 6px 0;
            font-size: 0.9em;
        }
        
        .legend-symbol {
            width: 30px;
            height: 20px;
            margin-right: 10px;
            border: 1px solid #3a2817;
        }
        
        .status-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(245, 234, 216, 0.98);
            border: 3px double #3a2817;
            padding: 30px 40px;
            border-radius: 5px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            text-align: center;
            z-index: 30;
            max-width: 500px;
        }
        
        .status-message h2 {
            font-family: 'Cinzel Decorative', cursive;
            font-size: 1.8em;
            color: #3a2817;
            margin-bottom: 15px;
        }
        
        .status-message p {
            font-size: 1em;
            color: #5a4a3a;
            line-height: 1.8;
            white-space: pre-line;
            text-align: left;
            margin: 10px 0;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #d4c5a9;
            border-top: 4px solid #3a2817;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            margin-top: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Coins d√©coratifs */
        .corner-decoration {
            position: absolute;
            width: 60px;
            height: 60px;
            pointer-events: none;
        }
        
        .corner-decoration.top-left {
            top: 0;
            left: 0;
            border-top: 4px solid #3a2817;
            border-left: 4px solid #3a2817;
        }
        
        .corner-decoration.top-right {
            top: 0;
            right: 0;
            border-top: 4px solid #3a2817;
            border-right: 4px solid #3a2817;
        }
        
        .corner-decoration.bottom-left {
            bottom: 0;
            left: 0;
            border-bottom: 4px solid #3a2817;
            border-left: 4px solid #3a2817;
        }
        
        .corner-decoration.bottom-right {
            bottom: 0;
            right: 0;
            border-bottom: 4px solid #3a2817;
            border-right: 4px solid #3a2817;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚öú Cartographia Exploratoria ‚öú</h1>
            <div class="subtitle">Carte en Temps R√©el des Terres D√©couvertes</div>
        </header>
        
        <div class="map-frame">
            <div class="corner-decoration top-left"></div>
            <div class="corner-decoration top-right"></div>
            <div class="corner-decoration bottom-left"></div>
            <div class="corner-decoration bottom-right"></div>
            
            <canvas id="mapCanvas"></canvas>
            
            <!-- Rose des vents -->
            <svg class="compass" viewBox="0 0 200 200">
                <defs>
                    <radialGradient id="compassGrad" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" style="stop-color:#f5ead8;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#d4c5a9;stop-opacity:1" />
                    </radialGradient>
                </defs>
                <circle cx="100" cy="100" r="95" fill="url(#compassGrad)" stroke="#3a2817" stroke-width="3"/>
                <circle cx="100" cy="100" r="85" fill="none" stroke="#5a4530" stroke-width="1" opacity="0.5"/>
                <circle cx="100" cy="100" r="70" fill="none" stroke="#5a4530" stroke-width="1" opacity="0.3"/>
                
                <!-- Pointe Nord (rouge) -->
                <path d="M 100 20 L 110 90 L 100 80 L 90 90 Z" fill="#8b3a3a" stroke="#3a2817" stroke-width="1.5"/>
                <text x="100" y="15" text-anchor="middle" font-family="Cinzel Decorative" font-size="16" fill="#3a2817" font-weight="bold">N</text>
                
                <!-- Pointe Sud -->
                <path d="M 100 180 L 110 110 L 100 120 L 90 110 Z" fill="#f5ead8" stroke="#3a2817" stroke-width="1.5"/>
                <text x="100" y="195" text-anchor="middle" font-family="Cinzel Decorative" font-size="16" fill="#3a2817">S</text>
                
                <!-- Pointe Est -->
                <path d="M 180 100 L 110 110 L 120 100 L 110 90 Z" fill="#d4c5a9" stroke="#3a2817" stroke-width="1.5"/>
                <text x="190" y="105" text-anchor="middle" font-family="Cinzel Decorative" font-size="16" fill="#3a2817">E</text>
                
                <!-- Pointe Ouest -->
                <path d="M 20 100 L 90 110 L 80 100 L 90 90 Z" fill="#d4c5a9" stroke="#3a2817" stroke-width="1.5"/>
                <text x="10" y="105" text-anchor="middle" font-family="Cinzel Decorative" font-size="16" fill="#3a2817">O</text>
                
                <!-- Centre -->
                <circle cx="100" cy="100" r="8" fill="#3a2817"/>
                <circle cx="100" cy="100" r="4" fill="#f5ead8"/>
            </svg>
            
            <!-- Panneau d'information -->
            <div class="info-panel">
                <h3>üìú Journal de Bord</h3>
                <div class="info-item">
                    <span class="info-label">Latitude:</span> <span id="latitude">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Longitude:</span> <span id="longitude">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Altitude:</span> <span id="altitude">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Distance parcourue:</span> <span id="distance">0 m</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Points cartographi√©s:</span> <span id="pointCount">0</span>
                </div>
            </div>
            
            <!-- L√©gende -->
            <div class="legend">
                <h4>‚öî L√©gende ‚öî</h4>
                <div class="legend-item">
                    <div class="legend-symbol" style="background: linear-gradient(135deg, #8b7355 0%, #6b5943 100%);"></div>
                    <span>Terres explor√©es</span>
                </div>
                <div class="legend-item">
                    <div class="legend-symbol" style="background: #4a7c8e; border-style: dashed;"></div>
                    <span>Cours d'eau</span>
                </div>
                <div class="legend-item">
                    <div class="legend-symbol" style="background: linear-gradient(to top, #5a7a4a 0%, #7a9a6a 100%);"></div>
                    <span>Reliefs & monts</span>
                </div>
                <div class="legend-item">
                    <div class="legend-symbol" style="background: #d4c5a9; border: 2px solid #8b3a3a;"></div>
                    <span>Votre route</span>
                </div>
            </div>
        </div>
        
        <!-- Contr√¥les -->
        <div class="controls">
            <button id="startBtn">‚öì Commencer l'Exploration</button>
            <button id="pauseBtn" disabled>‚è∏ Pause</button>
            <button id="clearBtn">üóë Nouvelle Exp√©dition</button>
        </div>
    </div>
    
    <!-- Message de statut -->
    <div class="status-message" id="statusMessage">
        <h2>üó∫Ô∏è Pr√™t √† Explorer</h2>
        <p>Cliquez sur "Commencer l'Exploration" pour d√©buter votre voyage cartographique √† travers les terres inconnues.</p>
        <p style="margin-top: 10px; font-size: 0.95em; font-style: italic;">
            L'application tracera votre parcours en temps r√©el avec le style des anciennes cartes des explorateurs.
        </p>
        <button id="testGeoBtn" style="margin-top: 15px; font-size: 0.9em;">
            üîç Tester la g√©olocalisation
        </button>
    </div>

    <script>
        class AncientCartographer {
            constructor() {
                this.canvas = document.getElementById('mapCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.watchId = null;
                this.isTracking = false;
                this.path = [];
                this.totalDistance = 0;
                this.lastPosition = null;
                
                // Param√®tres de la carte
                this.scale = 1000; // pixels par degr√©
                this.centerLat = 48.8566; // Paris par d√©faut
                this.centerLon = 2.3522;
                this.minLat = this.centerLat;
                this.maxLat = this.centerLat;
                this.minLon = this.centerLon;
                this.maxLon = this.centerLon;
                
                this.initCanvas();
                this.setupEventListeners();
                this.drawInitialMap();
                this.setupGeoTest();
            }
            
            setupGeoTest() {
                const testBtn = document.getElementById('testGeoBtn');
                if (testBtn) {
                    testBtn.addEventListener('click', () => {
                        this.testGeolocation();
                    });
                }
            }
            
            async testGeolocation() {
                const statusMsg = document.getElementById('statusMessage');
                statusMsg.querySelector('h2').textContent = 'üîç Diagnostic en cours...';
                statusMsg.querySelector('p').textContent = 'V√©rification de la g√©olocalisation...';
                
                // Test 1: Support du navigateur
                if (!navigator.geolocation) {
                    this.showStatus('‚ùå Non support√©', 
                        'Votre navigateur ne supporte pas la g√©olocalisation.\n\n' +
                        'Essayez avec:\n‚Ä¢ Chrome\n‚Ä¢ Firefox\n‚Ä¢ Safari\n‚Ä¢ Edge');
                    return;
                }
                
                // Test 2: Permissions
                try {
                    const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });
                    console.log('√âtat de permission:', permissionStatus.state);
                    
                    if (permissionStatus.state === 'denied') {
                        this.showStatus('‚ùå Permission bloqu√©e', 
                            'La g√©olocalisation est bloqu√©e dans votre navigateur.\n\n' +
                            'Pour d√©bloquer:\n\n' +
                            '1. Cliquez sur l\'ic√¥ne üîí dans la barre d\'adresse\n' +
                            '2. Cherchez "Localisation" ou "Position"\n' +
                            '3. Changez de "Bloquer" √† "Autoriser"\n' +
                            '4. Rechargez la page');
                        return;
                    }
                    
                    if (permissionStatus.state === 'prompt') {
                        this.showStatus('‚ö†Ô∏è Permission requise', 
                            'Le navigateur va vous demander l\'autorisation.\n\n' +
                            'Cliquez sur "Autoriser" dans la popup qui va appara√Ætre.');
                    }
                } catch (e) {
                    console.log('API Permissions non disponible');
                }
                
                // Test 3: Tentative d'acc√®s
                statusMsg.querySelector('h2').textContent = 'üì° Recherche de position...';
                statusMsg.querySelector('p').textContent = 'Patientez quelques secondes...';
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        this.showStatus('‚úÖ G√©olocalisation OK !', 
                            'Votre position a √©t√© d√©tect√©e avec succ√®s !\n\n' +
                            'üìç Latitude: ' + position.coords.latitude.toFixed(6) + '¬∞\n' +
                            'üìç Longitude: ' + position.coords.longitude.toFixed(6) + '¬∞\n' +
                            'üìè Pr√©cision: ¬±' + Math.round(position.coords.accuracy) + ' m\n\n' +
                            'Vous pouvez maintenant cliquer sur "Commencer l\'Exploration" !');
                    },
                    (error) => {
                        this.handleError(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    }
                );
            }
            
            initCanvas() {
                const rect = this.canvas.parentElement.getBoundingClientRect();
                this.canvas.width = rect.width;
                this.canvas.height = rect.height;
            }
            
            setupEventListeners() {
                document.getElementById('startBtn').addEventListener('click', () => this.startTracking());
                document.getElementById('pauseBtn').addEventListener('click', () => this.pauseTracking());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearMap());
                window.addEventListener('resize', () => this.initCanvas());
            }
            
            async startTracking() {
                if (this.isTracking) return;
                
                if (!navigator.geolocation) {
                    this.showStatus('Erreur', 'La g√©olocalisation n\'est pas support√©e par votre navigateur.');
                    return;
                }
                
                // V√©rifier d'abord les permissions
                try {
                    const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });
                    console.log('Permission status:', permissionStatus.state);
                    
                    if (permissionStatus.state === 'denied') {
                        this.showStatus('Permission refus√©e', 
                            'Vous avez bloqu√© l\'acc√®s √† la g√©olocalisation. Veuillez:\n\n' +
                            '1. Cliquer sur l\'ic√¥ne üîí ou ‚ìò dans la barre d\'adresse\n' +
                            '2. Autoriser l\'acc√®s √† la position\n' +
                            '3. Recharger la page\n\n' +
                            'Sur mobile: V√©rifiez les param√®tres de localisation dans R√©glages ‚Üí Safari/Chrome');
                        return;
                    }
                } catch (e) {
                    console.log('Permission API not supported, trying direct access');
                }
                
                this.showStatus('Recherche de position...', 'Acquisition de votre position GPS en cours...');
                
                // Essayer d'abord avec getCurrentPosition pour un diagnostic rapide
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log('Position acquired:', position);
                        this.hideStatus();
                        this.isTracking = true;
                        document.getElementById('startBtn').disabled = true;
                        document.getElementById('pauseBtn').disabled = false;
                        
                        // Traiter la premi√®re position
                        this.handlePosition(position);
                        
                        // Puis d√©marrer le tracking continu
                        this.watchId = navigator.geolocation.watchPosition(
                            (pos) => this.handlePosition(pos),
                            (error) => this.handleError(error),
                            {
                                enableHighAccuracy: true,
                                maximumAge: 10000,
                                timeout: 15000
                            }
                        );
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        this.handleError(error);
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 10000,
                        timeout: 15000
                    }
                );
            }
            
            pauseTracking() {
                if (!this.isTracking) return;
                
                this.isTracking = false;
                if (this.watchId !== null) {
                    navigator.geolocation.clearWatch(this.watchId);
                    this.watchId = null;
                }
                
                document.getElementById('startBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = true;
            }
            
            handlePosition(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const alt = position.coords.altitude || 0;
                
                // Mettre √† jour l'affichage
                document.getElementById('latitude').textContent = lat.toFixed(6) + '¬∞';
                document.getElementById('longitude').textContent = lon.toFixed(6) + '¬∞';
                document.getElementById('altitude').textContent = Math.round(alt) + ' m';
                
                // Calculer la distance si ce n'est pas le premier point
                if (this.lastPosition) {
                    const distance = this.calculateDistance(
                        this.lastPosition.lat,
                        this.lastPosition.lon,
                        lat,
                        lon
                    );
                    this.totalDistance += distance;
                    document.getElementById('distance').textContent = 
                        this.totalDistance < 1000 
                            ? Math.round(this.totalDistance) + ' m'
                            : (this.totalDistance / 1000).toFixed(2) + ' km';
                }
                
                // Ajouter le point au parcours
                this.path.push({ lat, lon, alt, timestamp: Date.now() });
                this.lastPosition = { lat, lon };
                
                // Mettre √† jour les limites
                this.updateBounds(lat, lon);
                
                // Recentrer si n√©cessaire
                if (this.path.length === 1) {
                    this.centerLat = lat;
                    this.centerLon = lon;
                }
                
                // Redessiner la carte
                this.drawMap();
                
                document.getElementById('pointCount').textContent = this.path.length;
            }
            
            handleError(error) {
                console.error('Geolocation error details:', error);
                let message = '';
                let title = 'Erreur de g√©olocalisation';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        title = 'üö´ Permission refus√©e';
                        message = 'L\'acc√®s √† votre position a √©t√© refus√©.\n\n';
                        message += 'üîß Solutions:\n\n';
                        message += '‚Ä¢ Sur ordinateur: Cliquez sur l\'ic√¥ne üîí dans la barre d\'adresse, puis autorisez la localisation\n\n';
                        message += '‚Ä¢ Sur iPhone: R√©glages ‚Üí Safari ‚Üí Localisation ‚Üí Autoriser\n\n';
                        message += '‚Ä¢ Sur Android: Param√®tres ‚Üí Sites et t√©l√©chargements ‚Üí Localisation ‚Üí Autoriser\n\n';
                        message += '‚Ä¢ V√©rifiez que le service de localisation est activ√© sur votre appareil\n\n';
                        message += 'Rechargez ensuite la page apr√®s avoir autoris√©.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        title = 'üì° Position indisponible';
                        message = 'Impossible de d√©terminer votre position.\n\n';
                        message += 'üîß V√©rifiez:\n\n';
                        message += '‚Ä¢ Que vous √™tes √† l\'ext√©rieur ou pr√®s d\'une fen√™tre\n';
                        message += '‚Ä¢ Que le GPS de votre appareil est activ√©\n';
                        message += '‚Ä¢ Votre connexion internet (pour le GPS assist√©)\n';
                        message += '‚Ä¢ R√©essayez dans quelques secondes';
                        break;
                    case error.TIMEOUT:
                        title = '‚è±Ô∏è D√©lai d√©pass√©';
                        message = 'La recherche de position a pris trop de temps.\n\n';
                        message += 'üîß Solutions:\n\n';
                        message += '‚Ä¢ D√©placez-vous √† l\'ext√©rieur\n';
                        message += '‚Ä¢ V√©rifiez votre signal GPS\n';
                        message += '‚Ä¢ R√©essayez';
                        break;
                    default:
                        message = 'Erreur inconnue (' + error.code + '): ' + error.message;
                }
                
                this.showStatus(title, message);
                this.pauseTracking();
            }
            
            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; // Rayon de la Terre en m√®tres
                const œÜ1 = lat1 * Math.PI / 180;
                const œÜ2 = lat2 * Math.PI / 180;
                const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
                const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
                
                const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                        Math.cos(œÜ1) * Math.cos(œÜ2) *
                        Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                
                return R * c;
            }
            
            updateBounds(lat, lon) {
                this.minLat = Math.min(this.minLat, lat);
                this.maxLat = Math.max(this.maxLat, lat);
                this.minLon = Math.min(this.minLon, lon);
                this.maxLon = Math.max(this.maxLon, lon);
            }
            
            latLonToCanvas(lat, lon) {
                const x = this.canvas.width / 2 + (lon - this.centerLon) * this.scale;
                const y = this.canvas.height / 2 - (lat - this.centerLat) * this.scale;
                return { x, y };
            }
            
            drawInitialMap() {
                this.ctx.fillStyle = '#f5ead8';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Ajouter une texture de vieux papier
                this.addParchmentTexture();
                
                // Titre au centre
                this.ctx.save();
                this.ctx.font = 'italic 28px "IM Fell DW Pica"';
                this.ctx.fillStyle = 'rgba(58, 40, 23, 0.15)';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('Terra Incognita', this.canvas.width / 2, this.canvas.height / 2);
                this.ctx.restore();
                
                // Grille d√©corative
                this.drawDecorativeGrid();
            }
            
            drawMap() {
                // Fond parchemin
                this.ctx.fillStyle = '#f5ead8';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.addParchmentTexture();
                
                // Grille d√©corative
                this.drawDecorativeGrid();
                
                // Dessiner le parcours
                if (this.path.length > 0) {
                    this.drawPath();
                    this.drawPathMarkers();
                }
                
                // Annotations d√©coratives
                this.drawDecorations();
            }
            
            addParchmentTexture() {
                // Ajouter des taches al√©atoires pour effet vieilli
                for (let i = 0; i < 30; i++) {
                    const x = Math.random() * this.canvas.width;
                    const y = Math.random() * this.canvas.height;
                    const radius = Math.random() * 20 + 10;
                    
                    const gradient = this.ctx.createRadialGradient(x, y, 0, x, y, radius);
                    gradient.addColorStop(0, 'rgba(139, 117, 87, 0.08)');
                    gradient.addColorStop(1, 'rgba(139, 117, 87, 0)');
                    
                    this.ctx.fillStyle = gradient;
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, radius, 0, Math.PI * 2);
                    this.ctx.fill();
                }
            }
            
            drawDecorativeGrid() {
                this.ctx.strokeStyle = 'rgba(58, 40, 23, 0.15)';
                this.ctx.lineWidth = 1;
                
                // Lignes verticales
                for (let x = 0; x < this.canvas.width; x += 50) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, 0);
                    this.ctx.lineTo(x, this.canvas.height);
                    this.ctx.stroke();
                }
                
                // Lignes horizontales
                for (let y = 0; y < this.canvas.height; y += 50) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y);
                    this.ctx.lineTo(this.canvas.width, y);
                    this.ctx.stroke();
                }
            }
            
            drawPath() {
                if (this.path.length < 2) return;
                
                // Ombre du trac√©
                this.ctx.strokeStyle = 'rgba(58, 40, 23, 0.3)';
                this.ctx.lineWidth = 6;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                this.ctx.beginPath();
                
                for (let i = 0; i < this.path.length; i++) {
                    const point = this.latLonToCanvas(this.path[i].lat, this.path[i].lon);
                    if (i === 0) {
                        this.ctx.moveTo(point.x + 2, point.y + 2);
                    } else {
                        this.ctx.lineTo(point.x + 2, point.y + 2);
                    }
                }
                this.ctx.stroke();
                
                // Trac√© principal avec effet encre
                const gradient = this.ctx.createLinearGradient(0, 0, this.canvas.width, this.canvas.height);
                gradient.addColorStop(0, '#8b3a3a');
                gradient.addColorStop(0.5, '#6b2a2a');
                gradient.addColorStop(1, '#5a1a1a');
                
                this.ctx.strokeStyle = gradient;
                this.ctx.lineWidth = 4;
                this.ctx.beginPath();
                
                for (let i = 0; i < this.path.length; i++) {
                    const point = this.latLonToCanvas(this.path[i].lat, this.path[i].lon);
                    if (i === 0) {
                        this.ctx.moveTo(point.x, point.y);
                    } else {
                        this.ctx.lineTo(point.x, point.y);
                    }
                }
                this.ctx.stroke();
                
                // Pointill√©s d√©coratifs sur le trac√©
                this.ctx.strokeStyle = 'rgba(212, 197, 169, 0.6)';
                this.ctx.lineWidth = 1;
                this.ctx.setLineDash([5, 5]);
                this.ctx.beginPath();
                
                for (let i = 0; i < this.path.length; i++) {
                    const point = this.latLonToCanvas(this.path[i].lat, this.path[i].lon);
                    if (i === 0) {
                        this.ctx.moveTo(point.x, point.y);
                    } else {
                        this.ctx.lineTo(point.x, point.y);
                    }
                }
                this.ctx.stroke();
                this.ctx.setLineDash([]);
            }
            
            drawPathMarkers() {
                // Point de d√©part
                if (this.path.length > 0) {
                    const start = this.latLonToCanvas(this.path[0].lat, this.path[0].lon);
                    this.drawMarker(start.x, start.y, '‚öì', '#3a7a5a', 'D√©part');
                }
                
                // Point actuel
                if (this.path.length > 1) {
                    const current = this.latLonToCanvas(
                        this.path[this.path.length - 1].lat,
                        this.path[this.path.length - 1].lon
                    );
                    this.drawMarker(current.x, current.y, 'üìç', '#8b3a3a', 'Position actuelle');
                }
                
                // Points interm√©diaires tous les 10 points
                for (let i = 10; i < this.path.length - 1; i += 10) {
                    const point = this.latLonToCanvas(this.path[i].lat, this.path[i].lon);
                    this.ctx.fillStyle = '#5a4530';
                    this.ctx.beginPath();
                    this.ctx.arc(point.x, point.y, 3, 0, Math.PI * 2);
                    this.ctx.fill();
                }
            }
            
            drawMarker(x, y, symbol, color, label) {
                // Ombre
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                this.ctx.beginPath();
                this.ctx.arc(x + 2, y + 2, 12, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Cercle de fond
                this.ctx.fillStyle = '#f5ead8';
                this.ctx.beginPath();
                this.ctx.arc(x, y, 12, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Bordure
                this.ctx.strokeStyle = color;
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                this.ctx.arc(x, y, 12, 0, Math.PI * 2);
                this.ctx.stroke();
                
                // Symbole
                this.ctx.font = '16px serif';
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText(symbol, x, y);
                
                // Label
                if (label) {
                    this.ctx.save();
                    this.ctx.font = 'italic 12px "IM Fell DW Pica"';
                    this.ctx.fillStyle = '#3a2817';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(label, x, y - 22);
                    this.ctx.restore();
                }
            }
            
            drawDecorations() {
                // Cartouche d√©coratif dans un coin
                if (this.path.length > 5) {
                    const x = this.canvas.width - 150;
                    const y = this.canvas.height - 100;
                    
                    // Fond du cartouche
                    this.ctx.fillStyle = 'rgba(245, 234, 216, 0.9)';
                    this.ctx.strokeStyle = '#3a2817';
                    this.ctx.lineWidth = 2;
                    this.ctx.beginPath();
                    this.ctx.roundRect(x, y, 130, 80, 5);
                    this.ctx.fill();
                    this.ctx.stroke();
                    
                    // Texte
                    this.ctx.fillStyle = '#3a2817';
                    this.ctx.font = 'italic 11px "IM Fell DW Pica"';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('Exp√©dition du', x + 65, y + 20);
                    
                    const date = new Date();
                    this.ctx.font = 'bold 13px "IM Fell DW Pica"';
                    this.ctx.fillText(date.toLocaleDateString('fr-FR'), x + 65, y + 38);
                    
                    this.ctx.font = 'italic 10px "IM Fell DW Pica"';
                    this.ctx.fillText('Cartographe:', x + 65, y + 55);
                    this.ctx.fillText('Explorateur Moderne', x + 65, y + 68);
                }
            }
            
            clearMap() {
                if (confirm('√ätes-vous s√ªr de vouloir effacer toute la carte et commencer une nouvelle exp√©dition ?')) {
                    this.pauseTracking();
                    this.path = [];
                    this.totalDistance = 0;
                    this.lastPosition = null;
                    
                    document.getElementById('latitude').textContent = '--';
                    document.getElementById('longitude').textContent = '--';
                    document.getElementById('altitude').textContent = '--';
                    document.getElementById('distance').textContent = '0 m';
                    document.getElementById('pointCount').textContent = '0';
                    
                    this.drawInitialMap();
                }
            }
            
            showStatus(title, message) {
                const statusDiv = document.getElementById('statusMessage');
                statusDiv.querySelector('h2').textContent = title;
                statusDiv.querySelector('p').textContent = message;
                statusDiv.style.display = 'block';
            }
            
            hideStatus() {
                document.getElementById('statusMessage').style.display = 'none';
            }
        }
        
        // Initialiser l'application
        const cartographer = new AncientCartographer();
    </script>
</body>
</html>
